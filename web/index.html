<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI Hedge Fund – Quick UI</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 12px 0; }
    label { font-size: 12px; opacity: .8; }
    input, select, button { padding: 8px; margin-top: 4px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f8f8f8; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: end; }
  </style>
</head>
<body>
  <h1>AI Hedge Fund – Quick UI</h1>

  <div class="card">
    <div class="row">
      <div>
        <label for="tickers">Tickers (comma-separated)</label><br/>
        <input id="tickers" placeholder="AAPL, MSFT, NVDA" style="min-width:260px"/>
      </div>
      <div>
        <label for="budget">Budget ($)</label><br/>
        <input id="budget" type="number" value="10000" min="0" step="100"/>
      </div>
      <div>
        <label for="risk">Risk</label><br/>
        <select id="risk">
          <option>low</option>
          <option selected>medium</option>
          <option>high</option>
        </select>
      </div>
      <div>
        <label for="agents">Agents (Ctrl/Cmd-click to multi-select)</label><br/>
        <select id="agents" multiple size="4" style="min-width:180px;"></select>
      </div>
      <div>
        <label for="llm_model">LLM model</label><br/>
        <input id="llm_model" value="gpt-4o-mini"/>
      </div>
      <div>
        <button id="run">Get Consensus</button>
      </div>
    </div>
  </div>

  <div id="status"></div>

  <div class="card" id="results" style="display:none;">
    <h3>Results</h3>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Decision</th>
            <th>Score</th>
            <th>Rationales (per agent)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
(async function init() {
  const status = (msg) => document.getElementById('status').textContent = msg || '';
  const agentsSel = document.getElementById('agents');

  // Load agent keys your server accepts
  async function loadAgents() {
    // Try registry (actual keys used by the endpoint)
    let keys = [];
    try {
      const r = await fetch('/debug/agents-registry');
      const j = await r.json();
      if (j.ok && Array.isArray(j.found) && j.found.length > 0) {
        // collect unique keys from all registries found
        const set = new Set();
        j.found.forEach(item => (item.keys || []).forEach(k => set.add(k)));
        keys = Array.from(set);
      }
    } catch {}

    // Fallback to module scan
    if (!keys.length) {
      try {
        const r = await fetch('/debug/agents-available');
        const j = await r.json();
        if (j.ok && Array.isArray(j.agents_by_module)) keys = j.agents_by_module;
      } catch {}
    }

    // Final fallback to our built-ins from router override
    if (!keys.length) keys = ["buffett","munger","technicals"];

    // Populate select
    agentsSel.innerHTML = '';
    keys.forEach(k => {
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = k;
      opt.selected = true; // preselect all
      agentsSel.appendChild(opt);
    });
  }

  await loadAgents();
  status('');

  document.getElementById('run').onclick = async () => {
    status('Running…');

    const tickers = document.getElementById('tickers').value
      .split(',').map(s => s.trim().toUpperCase()).filter(Boolean);

    const agents = Array.from(agentsSel.selectedOptions).map(o => o.value);

    const body = {
      budget: Number(document.getElementById('budget').value || 0),
      risk: document.getElementById('risk').value,
      agents,
      context: { note: "ui test" },
      mode: "llm",
      llm_model: document.getElementById('llm_model').value || "gpt-4o-mini"
    };

    // Your API accepts either symbol (single) or tickers (list)
    if (tickers.length <= 1) body.symbol = tickers[0] || "AAPL";
    else body.tickers = tickers;

    try {
      const r = await fetch('/agents/signal', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const j = await r.json();
      if (!r.ok) throw new Error(JSON.stringify(j));

      const results = j.results || [];
      const rows = results.map(res => {
        const rats = (res.decisions || []).map(d =>
          `<div><strong>${d.agent}:</strong> ${escapeHtml(d.rationale || '')}</div>`
        ).join('');
        return `<tr>
          <td>${res.ticker}</td>
          <td>${res.final_vote}</td>
          <td>${Number(res.final_score || 0).toFixed(2)}</td>
          <td>${rats}</td>
        </tr>`;
      }).join('');

      document.getElementById('tbody').innerHTML = rows || '<tr><td colspan="4">No results</td></tr>';
      document.getElementById('results').style.display = 'block';
      status('');
    } catch (e) {
      status('Error: ' + String(e));
    }
  };

  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));}
})();
</script>
</body>
</html>
